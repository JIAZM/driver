# **驱动的mmap机制**

- ## ***Linux 内存映射机制***
    - ### ***早期***
        > MMU 未开启或者没有 MMU  
        > CPU 通过物理地址访问外设 (包括物理内存)
    - ### ***启动 MMU 后***
        > CPU 核心对 MMU 发出***虚拟地址***  
        > MMU 将虚拟地址转换为物理地址，最后使用***物理地址***读取实际设备
    > 使用 MMU 为进程提供独立的内存虚拟地址空间  

- ## <u>***MMU***</u>
    > 内存管理单元 Memory Manage Unit
    - <u>负责虚拟地址到物理地址的***转换***</u>
    - <u>提供硬件机制的内存访问***权限***检查</u>

- ## <u>***虚拟地址转换为物理地址的方法***</u>
    - 确定的<u>***数学公式***</u>进行转换
    - 用<u>***表格***</u>存储虚拟地址对应的物理地址
        > Tiny210 使用第二种方法，根据每次转换时查表的次数分为**一级页表**方式
        > (以段的方式转换)和**二级页表**方式两种(以页的方式转换)
        - ### **Linux二级页表映射机制**
            ```
                    线性地址
                    31_____________22 21___________12 11_____________0
                    |___DIRECTORY____|_____TABLE_____|__OFFSET_(4k)__|
                            |                |              |
                            |                |              |    ____页___
                            |                |              ↓   |_________|
                            |                |              +-->|_________|
                            |                |    ________  ↑   |_________|
                            |                ↓   |________| |   |_________|
                            |                +-->|__&page_|---->|___head__|
                            |    _________   ↑   |________|
                            ↓   |_________|  |   |________|
                            +-->|__&table_|----->|__head__|
                            ↑   |_________|
                ___cr3___   |   |_________|
               |_________|----->|___head__|
            ```
            > 将物理内存划分为 4k 的块 (就是物理页面) (一般是 4k)  
            > 使用内核结构体struct page描述每个4k的块 (都是物理块)
            > 在 struct page 中记录每一个块的起始物理地址与结束地址  
            > 页目录的地址在 CR3 寄存器中保存

            #### <u>***用户空间各个进程的页目录表和页表不同，所以不同进程可以将同一个虚拟地址映射到不同的物理地址， 通过这种机制可以做到所有进程共享0~3G虚拟地址空间， 同时每个进程都可以保存私有数据***</u>